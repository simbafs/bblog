---
import { type GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import TreeElement from "../../components/TreeElement.astro";
import SidePanel from "../../components/layout/SidePanel.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import { config } from "../../site.config";

export const prerender = true;

export const getStaticPaths = (async () => {
  const collections = await getCollection("blog");
  const years = [
    ...new Set(collections.map((post) => post.data.publishDate.getFullYear())),
  ].sort((a, b) => b - a);

  return years.map((year) => ({
    params: { year },
    props: { years },
  }));
}) satisfies GetStaticPaths;

const posts = await getCollection("blog").then((posts) =>
  posts
    .toSorted(
      (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
    )
    .filter(
      (post) =>
        post.data.publishDate.getFullYear() === Number(Astro.params.year),
    ),
);

const { year } = Astro.params;
const { years } = Astro.props;

const links = years.map((year) => ({
  href: `/blog/${year}/`,
  text: `${year}`,
}));
---

<Layout title={`Blog in ${year}`} description={config.description}>
  <SidePanel links={links} slot="side-panel" cmd={`ls /blog/ | years`} />
  <section>
    <p>$ tree /blog --year {year}</p>
    <div>
      {
        posts.map((post, index) => (
          <TreeElement {...post} isLast={index == posts.length - 1}>
            <a href={`/blog/${post.id}/`}>
              <h4 class="font-bold">{post.data.title}</h4>
              <p class="date text-terminal-tertiary">
                <FormattedDate date={post.data.publishDate} />
              </p>
            </a>
            <div class="flex gap-2 italic">
              {post.data.tags.map((tag) => (
                <span>#{tag}</span>
              ))}
            </div>
            <p class="text-terminal-secondary text-sm">
              {post.data.description}
            </p>
          </TreeElement>
        ))
      }
    </div>
  </section>
</Layout>
